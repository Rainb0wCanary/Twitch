# Drops — Auto Collector

Расширение для автоматизации просмотра каналов с целью сбора дропов в определённых игровых категориях.

Это MV3-расширение помогает:

- Автоматически открывать каналы из списка и проверять наличие ссылки на игровую категорию.
- Отслеживать фактическое время просмотра по каждому каналу.

- `stats.html` / `stats.js` — подробная таблица со статусом каналов, логами и ручным управлением.
- `config.json` — пример конфигурации.

## Настройка (config.json)

Откройте `config.json` и настройте поля:

- `searchUrlPart`: строка — часть URL категории/игры, которую ищет content script (например, "rust").
- `channels`: массив объектов с каналами. Каждый объект содержит:
	- `url`: ссылка на канал стримера
	- `watchTime`: время просмотра в формате "H.MM.SS" (часы, минуты, секунды)
	- `dropId`: (опционально) ID группы дропа — если несколько каналов дают один и тот же дроп
	
	**Важно**: Если несколько каналов имеют одинаковый `dropId`, время просмотра суммируется между ними. 
	Когда суммарное время достигнет `watchTime`, все каналы группы блокируются.

	- Пример: 
	```json
	{
		"url": "https://www.twitch.tv/streamer1",
		"watchTime": "2.00.00",
		"dropId": "drop_1"
	}
	```
	
	- Формат `watchTime`: "H.MM.SS" — часы, минуты, секунды. Например, "2.00.00" = 2 часа, "0.10.30" = 10 минут 30 секунд.
	
- `waitBeforeCheck`: число — секунд ожидания перед проверкой наличия ссылки на игру после загрузки страницы.
- `maxAttempts`: число — сколько раз пробовать найти ссылку прежде чем поместить канал во временный ЧС.
- `tempBlacklistSeconds`: строка или число — сколько времени держать временный бан; можно указать как "H.MM.SS" или как число секунд.

### Пример конфигурации с группами дропов:

```json
{
	"searchUrlPart": "rust",
	"checkIntervalMinutes": 1,
	"channels": [
		{
			"url": "https://www.twitch.tv/streamer1",
			"watchTime": "2.00.00",
			"dropId": "drop_1"
		},
		{
			"url": "https://www.twitch.tv/streamer2",
			"watchTime": "2.00.00",
			"dropId": "drop_1"
		},
		{
			"url": "https://www.twitch.tv/streamer3",
			"watchTime": "1.30.00",
			"dropId": "drop_2"
		}
	],
	"waitBeforeCheck": 10,
	"maxAttempts": 5,
	"tempBlacklistSeconds": "0.5.00"
}
```

В этом примере:
- `streamer1` и `streamer2` — дают один и тот же дроп (`drop_1`). Можно смотреть 1 час одного, затем 1 час другого — после 2 часов суммарно оба канала блокируются.
- `streamer3` — отдельный дроп (`drop_2`), требует 1.5 часа просмотра.

### Пример конфигурации без группировки (старый формат):

```json
{
	"searchUrlPart": "rust",
	"channels": [
		{ "url": "https://www.twitch.tv/templetaps", "watchTime": "0.10.30" },
		{ "url": "https://www.twitch.tv/posty", "watchTime": "0.10.30" },
		{ "url": "https://www.twitch.tv/shroud", "watchTime": "0.10.30" }
	],
	"waitBeforeCheck": 10,
	"maxAttempts": 5,
	"tempBlacklistSeconds": "0.5.30"
}
```

## Как использовать

- Откройте popup (иконка расширения) и загрузите `config.json` при первом запуске.
- Нажмите "Start" (Старт просмотра) — фоновой воркер начнёт последовательно или параллельно открывать каналы (в фоне) и проверять наличие ссылки на категорию.
- Если ссылка найдена, канал считается валидным и начнёт отсчёт времени просмотра по указанному `watchTime`.
- Когда время просмотра закончится, расширение перейдёт к следующему каналу.
- В `stats.html` отображается подробная информация: URL канала, общее время просмотренных секунд, статус (Active / Blacklisted / Temp blacklisted), количество попыток, кнопки "Сбросить", "Сделать неактивным/активным" и пр.
- Управление логами: включите/выключите запись логов в popup — если логи выключены, они не сохраняются в storage.

Особенности поведения:

- Если все каналы оказались в ЧС — процесс приостанавливается и ждёт, пока хотя бы один канал не выйдет из ЧС.
- Временная блокировка управляется параметром `tempBlacklistSeconds` — после истечения времени канал автоматически снимается с временного бана.
- Background сервис-воркер ориентирован на хранение состояния в `chrome.storage.local`, поэтому он устойчив к перезапускам воркера.

## Быстрое формирование конфига через скрипт сбора ссылок

Для автоматического сбора дропов с платформы используйте скрипт `collect_drops_links.js`:

### Инструкция:

1. Откройте страницу с дропами

2. Откройте DevTools (F12) → вкладка Console

3. Скопируйте и вставьте скрипт из файла collect_drops_links.js в консоль

4. Нажмите Enter — скрипт автоматически:
   - Найдёт все доступные дропы на странице
   - Соберёт каналы для каждого дропа
   - Сгруппирует их по `dropId`
   - Сформирует готовый `config.json`


5. Вставьте полученный конфиг в файл `config.json`


**Примечание**: Скрипт — это вспомогательный инструмент. Селекторы могут отличаться в зависимости от версии сайта. При необходимости отредактируйте скрипт под актуальную структуру HTML.


## Часто задаваемые вопросы

**Q: Что если в группе один стример офлайн?**  
A: Расширение автоматически переключится на другой канал группы.

**Q: Могу ли я смешивать каналы с группами и без?**  
A: Да, в одном конфиге могут быть и сгруппированные, и независимые каналы.

**Q: Сбрасывается ли время при ручном переключении?**  
A: Нет, суммарное время группы сохраняется в `chrome.storage.local`.

**Q: Можно ли добавить канал в несколько групп?**  
A: Технически да, но это не рекомендуется — канал будет учитываться только в одной группе (первой найденной).

## Советы по отладке

- Откройте DevTools popup (правый клик → Inspect popup) чтобы увидеть сообщения и ошибки от `popup.js`.
- Откройте DevTools для страницы со стримом, чтобы отследить работу `content.js`.
- Проверяйте `chrome.storage.local` через DevTools Application → Storage → Extensions → Local Storage или вызовом `chrome.storage.local.get(null, console.log)` в консоли background.

## Безопасность и ограничения

- Расширение использует `chrome.tabs.create({ active: false })` для незаметного открытия вкладок — не закрывайте вкладки ручным образом, иначе логика времени просмотров может быть нарушена.
- Не храните секреты в конфиге — расширение не требует токенов, но хранит настройки в `chrome.storage.local`.
- Поведение может отличаться между версиями Chrome и Chromium-подобными браузерами из-за изменений в API MV3.

## Ссылки и контакты

- Telegram: @RainbowCanary
- Discord: rainbowcanary
- Mail: rainbowcanaryyt@gmail.com
- GitHub: RainbowCanary
